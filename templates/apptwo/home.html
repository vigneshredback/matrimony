{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile CRUD</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Profile List</h1>
    
    <!-- Add Form -->
    <h2>Add Profile</h2>
    <form id="add-profile-form">
        {% csrf_token %}
        <input type="text" name="name" placeholder="Name" required><br>
        <input type="email" name="email" placeholder="Email" required><br>
        <input type="number" name="age" placeholder="Age" required><br>
        <input type="text" name="city" placeholder="City" required><br>
        <button type="submit">Add Profile</button>
    </form>

    <!-- Profile List -->
    <h2>Profile List</h2>
    <table id="profile-list">
        <!-- Profiles will be dynamically populated here -->
    </table>

    <!-- Edit Form (Hidden initially) -->
    <h2>Edit Profile</h2>
    <form id="edit-profile-form" style="display:none;">
        {% csrf_token %}
        <input type="hidden" name="id">
        <input type="text" name="name" required><br>
        <input type="email" name="email" required><br>
        <input type="number" name="age" required><br>
        <input type="text" name="city" required><br>
        <button type="submit">Update Profile</button>
    </form>

    <script>
        $(document).ready(function() {
            // Fetch all profiles on page load
            function fetchProfiles() {
                $.ajax({
                    url: "{% url 'profile_list' %}",
                    method: 'GET',
                    success: function(response) {
                        let profileTable = '';
                        response.forEach(profile => {
                            profileTable += `
                                <tr data-id="${profile.id}">
                                    <td>${profile.name}</td>
                                    <td>${profile.email}</td>
                                    <td>${profile.age}</td>
                                    <td>${profile.city}</td>
                                    <td>
                                        <button class="edit-btn">Edit</button>
                                        <button class="delete-btn">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });
                        $('#profile-list').html(profileTable);
                    }
                });
            }

            fetchProfiles();

            // Add new profile
            $('#add-profile-form').on('submit', function(e) {
                e.preventDefault();
                const formData = $(this).serialize();

                $.ajax({
                    url: "{% url 'profile_add' %}",
                    method: 'POST',
                    data: formData,
                    success: function() {
                        fetchProfiles();
                        $('#add-profile-form')[0].reset();
                    }
                });
            });

            // Edit profile button click
            $('#profile-list').on('click', '.edit-btn', function() {
                const profileRow = $(this).closest('tr');
                const id = profileRow.data('id');
                const name = profileRow.children('td').eq(0).text();
                const email = profileRow.children('td').eq(1).text();
                const age = profileRow.children('td').eq(2).text();
                const city = profileRow.children('td').eq(3).text();

                $('#edit-profile-form').show();
                $('#edit-profile-form input[name="id"]').val(id);
                $('#edit-profile-form input[name="name"]').val(name);
                $('#edit-profile-form input[name="email"]').val(email);
                $('#edit-profile-form input[name="age"]').val(age);
                $('#edit-profile-form input[name="city"]').val(city);
            });

            // Update profile
            $('#edit-profile-form').on('submit', function(e) {
                e.preventDefault();
                const formData = $(this).serialize();

                $.ajax({
                    url: "{% url 'profile_edit' %}",
                    method: 'POST',
                    data: formData,
                    success: function() {
                        fetchProfiles();
                        $('#edit-profile-form').hide();
                    }
                });
            });

            // Delete profile
            $('#profile-list').on('click', '.delete-btn', function() {
                const profileRow = $(this).closest('tr');
                const id = profileRow.data('id');

                $.ajax({
                    url: "{% url 'profile_delete' %}",
                    method: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        id: id
                    },
                    success: function() {
                        fetchProfiles();
                    }
                });
            });
        });
    </script>
</body>
</html>
