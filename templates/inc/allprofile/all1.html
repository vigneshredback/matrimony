{% load static %}
<div class="all-list-sh">
    <ul id="profile-list">
        {% for item in profiles %}
        <li>
            <div class="all-pro-box user-avil-onli" data-useravil="avilyes" data-aviltxt="Available online">
                <div class="pro-img">
                    <a href="{% url 'profile_detail' item.id %}">
                        {% if not item.image1 %}
                        {% if item.gender == 'Male' %}
                            <img src="{% static 'images/couples/maleavatar.jpg' %}" alt="male">
                        {% else %}
                            <img src="{% static 'images/couples/femaleavatar.jpg' %}" alt="female">
                        {% endif %}
                        {% else %}
                            <img src="{{ item.image1.url }}" alt="original">
                        {% endif %}
                    </a>
                    <div class="pro-ave" title="User currently available">
                        <span class="pro-ave-yes"></span>
                    </div>
                </div>
                <div class="pro-detail">
                    <h4><a href="{% url 'profile_detail' item.id %}">{{ item.user.name }}</a></h4>
                    <div class="pro-bio">
                        <span class="bg-primary">Id: {{item.id}}</span>

                        <span>{{ item.degree }}</span>
                        <span>{{ item.profession }}</span>
                        <span>Age: {{ item.age }}</span>
                        <span>Height: {{ item.height }}</span>
                    </div>
                    <div class="links">
                        {% if item.plan_id == 1 %}
                        <span class="bg-secondary text-white">free user</span>
                        {% elif item.plan_id == 2 %}
                        <span class="bg-warning text-white">premium user</span>
                        {% endif %}
                        <a href="profile-details.html">More details</a>

                        <a href="#!">WhatsApp</a>
                        {% if item.user_has_interest %}
                        <span href="#!" class="cta cta-sendint interest-icon bg-success text-white"  data-bs-target="#sendInter" data-biodata-id="{{ item.id }}" data-liked="true" title="Click to remove interest.">interested</span>
                        {% else %}
                        <span href="#!" class="cta cta-sendint interest-icon"  data-bs-target="#sendInter" data-biodata-id="{{ item.id }}" data-liked="false" title="Click to interest.">send interest</span>
                        {% endif %}


                    </div>
                </div>
                {% if item.user_has_liked %}
                <span class="enq-sav like-icon" data-biodata-id="{{ item.id }}" data-liked="true" title="Click to remove like.">
                    <i class="fa fa-thumbs-up" aria-hidden="true" style="color: green !important;"></i>
                </span>
                {% else %}
                <span class="enq-sav like-icon" data-biodata-id="{{ item.id }}" data-liked="false" title="Click to like.">
                    <i class="fa fa-thumbs-o-down" aria-hidden="true" ></i>
                </span>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<div id="loading" style="display: none;">Loading...</div>

<script>
    let page = 2;  // Start with page 2 because page 1 is already loaded
    let loading = false;
    let hasNextPage = true;

    window.onscroll = function() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !loading && hasNextPage) {
            loadMoreProfiles();
        }
    };

    function loadMoreProfiles() {
        loading = true;
        document.getElementById('loading').style.display = 'block';

        fetch('/allprofiles/?page=' + page, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const profileList = document.getElementById('profile-list');
            data.profiles.forEach(item => {
                const li = document.createElement('li');
                const imgSrc = item.image1 ? item.image1 : (item.gender === 'Male' ? '/static/images/couples/maleavatar.jpg' : '/static/images/couples/femaleavatar.jpg');
                li.innerHTML = `
                    <div class="all-pro-box user-avil-onli" data-useravil="avilyes" data-aviltxt="Available online">
                        <div class="pro-img">
                            <a href="/profile-detail/${item.id}/">
                                <img src="${imgSrc}" alt="${item.gender}">
                            </a>
                            <div class="pro-ave" title="User currently available">
                                <span class="pro-ave-yes"></span>
                            </div>
                        </div>
                        <div class="pro-detail">
                            <h4><a href="/profile-detail/${item.id}/">${item.name}</a></h4>
                            <div class="pro-bio">
                                <span class="bg-primary">Id: ${item.id}</span>
                                <span>${item.degree}</span>
                                <span>${item.profession}</span>
                                <span>Age: ${item.age}</span>
                                <span>Height: ${item.height}</span>
                            </div>
                            <div class="links">
                                ${item.plan_id == 1 ? '<span class="bg-secondary text-white">free user</span>' : item.plan_id == 2 ? '<span class="bg-warning text-white">premium user</span>' : '' }
                                <a href="#!">WhatsApp</a>




                        ${item.user_has_interest ? 
                            `<span href="#!" class="cta cta-sendint interest-icon bg-success text-white"  data-bs-target="#sendInter" data-biodata-id="${ item.id }" data-liked="true" title="Click to remove interest.">interested</span>` : 
                            `<span href="#!" class="cta cta-sendint interest-icon"  data-bs-target="#sendInter" data-biodata-id="${ item.id }" data-liked="false" title="Click to interest.">send interest</span>`
                        }


                                <a href="profile-details.html">More details</a>
                            </div>
                        </div>
                        ${item.user_has_liked ? 
                            `<span class="enq-sav like-icon" data-biodata-id="${item.id}" data-liked="true" title="Click to remove like.">
                                <i class="fa fa-thumbs-up" aria-hidden="true" style="color: green !important;"></i>
                            </span>` : 
                            `<span class="enq-sav like-icon" data-biodata-id="${item.id}" data-liked="false" title="Click to like.">
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>
                            </span>`
                        }
                    </div>
                `;
                profileList.appendChild(li);
            });

            page += 1;
            loading = false;
            document.getElementById('loading').style.display = 'none';
            hasNextPage = data.has_next;

            // Reattach event handlers after new profiles are loaded
            attachLikeIconHandlers();
            attachInterestIconHandlers();
        })
        .catch(() => {
            loading = false;
            document.getElementById('loading').style.display = 'none';
            // Optional: Handle error, show user message
        });
    }

    function attachLikeIconHandlers() {
        const likeIcons = document.querySelectorAll('.like-icon');
        likeIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const biodataId = this.getAttribute('data-biodata-id');
                const isLiked = this.getAttribute('data-liked') === 'true';

                fetch(`/post/${biodataId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',  // Django's CSRF protection
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    toastr.options = {
                        "closeButton": true,           // Close button on the toast
                        "debug": false,
                        "newestOnTop": true,           // Display the newest toast on top
                        "progressBar": true,           // Show progress bar
                        "positionClass": "toast-top-right", // Position of the toast (you can change to other positions)
                        "preventDuplicates": false,    // Allow duplicate toasts
                        "onclick": null,
                        "showDuration": "300",         // How long it takes to show (in milliseconds)
                        "hideDuration": "1000",        // How long it takes to hide (in milliseconds)
                        "timeOut": "1000",             // Display duration of the toast (5000ms = 5 seconds)
                        "extendedTimeOut": "2000",     // Extra time when hovering over the toast (in milliseconds)
                        "showEasing": "swing",         // Animation easing when showing the toast
                        "hideEasing": "linear",        // Animation easing when hiding the toast
                        "showMethod": "fadeIn",        // Show method
                        "hideMethod": "fadeOut"        // Hide method
                      };
                    if (data.liked) {
                        this.innerHTML = '<i class="fa fa-thumbs-up" aria-hidden="true" style="color: green !important;"></i>'; // Liked state
                        this.setAttribute('data-liked', 'true');
                        this.setAttribute('title', 'Click to remove like.');
                        toastr["{{ message.tags|default:'success' }}"]("like added");
                    } else {
                        this.innerHTML = '<i class="fa fa-thumbs-o-down" aria-hidden="true"></i>'; // Not liked state
                        this.setAttribute('data-liked', 'false');
                        this.setAttribute('title', 'Click to like.');
                        toastr["{{ message.tags|default:'error' }}"]("like removed");
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    }

    function attachInterestIconHandlers() {
        const interestIcons = document.querySelectorAll('.interest-icon');
        interestIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const biodataId = this.getAttribute('data-biodata-id');
                const isLiked = this.getAttribute('data-liked') === 'true';

                fetch(`/post/${biodataId}/interest/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',  // Django's CSRF protection
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    toastr.options = {
                        "closeButton": true,           // Close button on the toast
                        "debug": false,
                        "newestOnTop": true,           // Display the newest toast on top
                        "progressBar": true,           // Show progress bar
                        "positionClass": "toast-top-right", // Position of the toast (you can change to other positions)
                        "preventDuplicates": false,    // Allow duplicate toasts
                        "onclick": null,
                        "showDuration": "300",         // How long it takes to show (in milliseconds)
                        "hideDuration": "1000",        // How long it takes to hide (in milliseconds)
                        "timeOut": "1000",             // Display duration of the toast (5000ms = 5 seconds)
                        "extendedTimeOut": "2000",     // Extra time when hovering over the toast (in milliseconds)
                        "showEasing": "swing",         // Animation easing when showing the toast
                        "hideEasing": "linear",        // Animation easing when hiding the toast
                        "showMethod": "fadeIn",        // Show method
                        "hideMethod": "fadeOut"        // Hide method
                      };
                    if (data.interested) {
                        this.innerHTML = 'interested'; // Liked state
                        this.setAttribute('data-liked', 'true');
                        this.setAttribute('class', 'text-white bg-success');
                        this.setAttribute('title', 'Click to remove like.');
                        toastr["{{ message.tags|default:'success' }}"]("interest sent succesfully");
                      
                    } else {
                        this.innerHTML = 'send interest'; // Not liked state
                        this.setAttribute('data-liked', 'false');
                        this.setAttribute('class', 'text-dark bg-white');
                        this.setAttribute('title', 'Click to like.');
                        toastr["{{ message.tags|default:'error' }}"]("interest revoked");
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    }


    

    // Attach event handlers on page load
    document.addEventListener('DOMContentLoaded', attachLikeIconHandlers);
    document.addEventListener('DOMContentLoaded', attachInterestIconHandlers);

</script>
