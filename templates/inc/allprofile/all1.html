{% load static %}
<div class="all-list-sh">
    <ul id="profile-list">
        {% for item in profiles %}
        <li>
            <div class="all-pro-box user-avil-onli" data-useravil="avilyes" data-aviltxt="Available online">
                <div class="pro-img">
                    <a href="{% url 'profile_detail' item.id %}">
                        {% if not item.image1 %}
                        {% if item.gender == 'Male' %}
                            <img src="{% static 'images/couples/maleavatar.jpg' %}" alt="male">
                        {% else %}
                            <img src="{% static 'images/couples/femaleavatar.jpg' %}" alt="female">
                        {% endif %}
                        {% else %}
                            <img src="{{ item.image1.url }}" alt="original">
                        {% endif %}
                    </a>
                    <div class="pro-ave" title="User currently available">
                        <span class="pro-ave-yes"></span>
                    </div>
                </div>
                <div class="pro-detail">
                    <h4><a href="{% url 'profile_detail' item.id %}">{{ item.user.name }}</a></h4>
                    <div class="pro-bio">
                        <span>{{ item.degree }}</span>
                        <span>{{ item.profession }}</span>
                        <span>Age: {{ item.age }}</span>
                        <span>Height: {{ item.height }}</span>
                    </div>
                    <div class="links">
                        <a href="#!">WhatsApp</a>
                        <a href="#!" class="cta cta-sendint" data-bs-toggle="modal" data-bs-target="#sendInter">Send interest</a>
                        <a href="profile-details.html">More details</a>
                    </div>
                </div>
                {% if item.user_has_liked %}
                <span class="enq-sav like-icon" data-biodata-id="{{ item.id }}" data-liked="true" title="Click to remove like.">
                    <i class="fa fa-thumbs-down" aria-hidden="true"></i> <!-- Liked state -->
                </span>
                {% else %}
                <span class="enq-sav like-icon" data-biodata-id="{{ item.id }}" data-liked="false" title="Click to like.">
                    <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> <!-- Not liked state -->
                </span>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<div id="loading" style="display: none;">Loading...</div>

<script>
    let page = 2;  // Start with page 2 because page 1 is already loaded
    let loading = false;
    let hasNextPage = true;

    window.onscroll = function() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !loading && hasNextPage) {
            loadMoreProfiles();
        }
    };

    function loadMoreProfiles() {
        loading = true;
        document.getElementById('loading').style.display = 'block';

        fetch('/allprofiles/?page=' + page, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const profileList = document.getElementById('profile-list');
            data.profiles.forEach(item => {
                const li = document.createElement('li');
                const imgSrc = item.image1 ? item.image1 : (item.gender === 'Male' ? '/static/images/couples/maleavatar.jpg' : '/static/images/couples/femaleavatar.jpg');
                li.innerHTML = `
                    <div class="all-pro-box user-avil-onli" data-useravil="avilyes" data-aviltxt="Available online">
                        <div class="pro-img">
                            <a href="/profile-detail/${item.id}/">
                                <img src="${imgSrc}" alt="${item.gender}">
                            </a>
                            <div class="pro-ave" title="User currently available">
                                <span class="pro-ave-yes"></span>
                            </div>
                        </div>
                        <div class="pro-detail">
                            <h4><a href="/profile-detail/${item.id}/">${item.name}</a></h4>
                            <div class="pro-bio">
                                <span>${item.degree}</span>
                                <span>${item.profession}</span>
                                <span>Age: ${item.age}</span>
                                <span>Height: ${item.height}</span>
                            </div>
                            <div class="links">
                                <a href="#!">WhatsApp</a>
                                <a href="#!" class="cta cta-sendint" data-bs-toggle="modal" data-bs-target="#sendInter">Send interest</a>
                                <a href="profile-details.html">More details</a>
                            </div>
                        </div>
                        ${item.user_has_liked ? 
                            `<span class="enq-sav like-icon" data-biodata-id="${item.id}" data-liked="true" title="Click to remove like.">
                                <i class="fa fa-thumbs-down" aria-hidden="true"></i>
                            </span>` : 
                            `<span class="enq-sav like-icon" data-biodata-id="${item.id}" data-liked="false" title="Click to like.">
                                <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>
                            </span>`
                        }
                    </div>
                `;
                profileList.appendChild(li);
            });

            page += 1;
            loading = false;
            document.getElementById('loading').style.display = 'none';
            hasNextPage = data.has_next;

            // Reattach event handlers after new profiles are loaded
            attachLikeIconHandlers();
        })
        .catch(() => {
            loading = false;
            document.getElementById('loading').style.display = 'none';
            // Optional: Handle error, show user message
        });
    }

    function attachLikeIconHandlers() {
        const likeIcons = document.querySelectorAll('.like-icon');
        likeIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const biodataId = this.getAttribute('data-biodata-id');
                const isLiked = this.getAttribute('data-liked') === 'true';

                fetch(`/post/${biodataId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',  // Django's CSRF protection
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        this.innerHTML = '<i class="fa fa-thumbs-down" aria-hidden="true"></i>'; // Liked state
                        this.setAttribute('data-liked', 'true');
                        this.setAttribute('title', 'Click to remove like.');
                    } else {
                        this.innerHTML = '<i class="fa fa-thumbs-o-up" aria-hidden="true"></i>'; // Not liked state
                        this.setAttribute('data-liked', 'false');
                        this.setAttribute('title', 'Click to like.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    }

    // Attach event handlers on page load
    document.addEventListener('DOMContentLoaded', attachLikeIconHandlers);
</script>
