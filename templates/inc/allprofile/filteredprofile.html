<!-- Your existing content goes here -->
{% load static %}
<div class="all-list-sh">
    <ul id="profile-list">
        {% for item in profiles %}
        <li>
            <div class="all-pro-box user-avil-onli" data-useravil="avilyes" data-aviltxt="Available online">
                <div class="pro-img">
                    <a href="{% url 'profile_detail' item.id %}">
                        {% if not item.image1 %}
                        {% if item.gender == 'Male' %}
                            <img src="{% static 'images/couples/maleavatar.jpg' %}" alt="male">
                        {% else %}
                            <img src="{% static 'images/couples/femaleavatar.jpg' %}" alt="female">
                        {% endif %}
                        {% else %}
                            <img src="{{ item.image1.url }}" alt="original">
                        {% endif %}
                    </a>
                    <div class="pro-ave" title="User currently available">
                        <span class="pro-ave-yes"></span>
                    </div>
                </div>
                <div class="pro-detail">
                    <h4><a href="{% url 'profile_detail' item.id %}">{{ item.user.name }}</a></h4>
                    <div class="pro-bio">
                        <span class="bg-primary">Id: {{item.id}}</span>
                        <span>{{ item.degree }}</span>
                        <span>{{ item.profession }}</span>
                        <span>Age: {{ item.age }}</span>
                        <span>Height: {{ item.height }}</span>
                    </div>
                    <div class="links">
                        <a href="#!">WhatsApp</a>
                        {% if item.user_has_interest %}
                        <span href="#!" class="cta cta-sendint interest-icon bg-success text-white"  data-bs-target="#sendInter" data-biodata-id="{{ item.id }}" data-liked="true" title="Click to remove interest.">interested</span>
                        {% else %}
                        <span href="#!" class="cta cta-sendint interest-icon"  data-bs-target="#sendInter" data-biodata-id="{{ item.id }}" data-liked="false" title="Click to interest.">send interest</span>
                        {% endif %}
                        <a href="profile-details.html">More details</a>
                    </div>
                </div>
                {% if item.user_has_liked %}
                <span class="enq-sav like-icon" data-biodata-id="{{ item.id }}" data-liked="true" title="Click to remove like.">
                    <i class="fa fa-thumbs-up" aria-hidden="true" style="color: green !important;"></i>
                </span>
                {% else %}
                <span class="enq-sav like-icon" data-biodata-id="{{ item.id }}" data-liked="false" title="Click to like.">
                    <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>
                </span>
                {% endif %}

            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<div id="loading" style="display: none;"></div>
<div class="text-center">-- End of results --</div>






<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.querySelector('#profile-list');
        const loadingIndicator = document.getElementById('loading');
        let page = 1;
        let isLoading = false;
        let hasNext = true;
        const loadedProfileIds = new Set(); // To track loaded profiles

        function loadMoreProfiles() {
            if (!hasNext || isLoading) return;

            isLoading = true;
            loadingIndicator.style.display = 'block';

            page++;
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `/search/?page=${page}&gender={{ gender }}&age={{ age }}&religion={{ religion }}&city={{ city }}&profile_type={{ profile_type }}`, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    hasNext = response.has_next;
                    const profiles = response.profiles;
                    console.log(profiles)

                    if (profiles.length) {
                        profiles.forEach(profile => {
                            // Check if the profile is already loaded
                            if (loadedProfileIds.has(profile.id)) {
                                return; // Skip adding if already loaded
                            }

                            loadedProfileIds.add(profile.id); // Mark this profile as loaded

                            const li = document.createElement('li');
                            const imgSrc = profile.image1 || (profile.gender === 'Male'
                                ? '{% static "images/couples/maleavatar.jpg" %}'
                                : '{% static "images/couples/femaleavatar.jpg" %}');

                            li.innerHTML = `
                                <div class="all-pro-box user-avil-onli" data-useravil="avilyes" data-aviltxt="Available online">
                                    <div class="pro-img">
                                        <a href="/profile-detail/${profile.id}/">
                                            <img src="${imgSrc}" alt="${profile.gender}">
                                        </a>
                                        <div class="pro-ave" title="User currently available">
                                            <span class="pro-ave-yes"></span>
                                        </div>
                                    </div>
                                    <div class="pro-detail">
                                        <h4><a href="/profile-detail/${profile.id}/">${profile.name}</a></h4>
                                        <div class="pro-bio">
                                            <span>${profile.degree}</span>
                                            <span>${profile.profession}</span>
                                            <span>Age: ${profile.age}</span>
                                            <span>Height: ${profile.height}</span>
                                        </div>
                                        <div class="links">
                                            <a href="#!">WhatsApp</a>
                    ${profile.user_has_interest ? 
                            `<span href="#!" class="cta cta-sendint interest-icon bg-success text-white"  data-bs-target="#sendInter" data-biodata-id="${ profile.id }" data-liked="true" title="Click to remove interest.">interested</span>` : 
                            `<span href="#!" class="cta cta-sendint interest-icon"  data-bs-target="#sendInter" data-biodata-id="${ profile.id }" data-liked="false" title="Click to interest.">send interest</span>`
                        }
                                            <a href="profile-details.html">More details</a>
                                        </div>
                                    </div>
                                    ${profile.user_has_liked ? 
                                        `<span class="enq-sav like-icon" data-biodata-id="${profile.id}" data-liked="true" title="Click to remove like.">
                                            <i class="fa fa-thumbs-up" aria-hidden="true" style="color: green !important;"></i>
                                        </span>` : 
                                        `<span class="enq-sav like-icon" data-biodata-id="${profile.id}" data-liked="false" title="Click to like.">
                                            <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>
                                        </span>`
                                    }
                                </div>`;
                            container.appendChild(li);
                        });

                        // Re-attach event listeners for new like icons
                        attachLikeIconHandlers();
                        attachInterestIconHandlers();
                    }

                    isLoading = false;
                    loadingIndicator.style.display = 'none';
                }
            };

            xhr.onerror = function() {
                console.error("An error occurred while fetching profiles.");
                isLoading = false;
                loadingIndicator.style.display = 'none';
            };

            xhr.send();
        }

        window.addEventListener('scroll', function() {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !isLoading) {
                loadMoreProfiles();
            }
        });
    });

    function attachLikeIconHandlers() {
        const likeIcons = document.querySelectorAll('.like-icon');
        likeIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const biodataId = this.getAttribute('data-biodata-id');
                const isLiked = this.getAttribute('data-liked') === 'true';

                fetch(`/post/${biodataId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    toastr.options = {
                                "closeButton": true,           // Close button on the toast
                                "debug": false,
                                "newestOnTop": true,           // Display the newest toast on top
                                "progressBar": true,           // Show progress bar
                                "positionClass": "toast-top-right", // Position of the toast (you can change to other positions)
                                "preventDuplicates": false,    // Allow duplicate toasts
                                "onclick": null,
                                "showDuration": "300",         // How long it takes to show (in milliseconds)
                                "hideDuration": "1000",        // How long it takes to hide (in milliseconds)
                                "timeOut": "1000",             // Display duration of the toast (5000ms = 5 seconds)
                                "extendedTimeOut": "2000",     // Extra time when hovering over the toast (in milliseconds)
                                "showEasing": "swing",         // Animation easing when showing the toast
                                "hideEasing": "linear",        // Animation easing when hiding the toast
                                "showMethod": "fadeIn",        // Show method
                                "hideMethod": "fadeOut"        // Hide method
                              };
                    if (data.liked) {
                        this.innerHTML = '<i class="fa fa-thumbs-up" aria-hidden="true" style="color: green !important;"></i>';
                        this.setAttribute('data-liked', 'true');
                        this.setAttribute('title', 'Click to remove like.');
                        toastr["{{ message.tags|default:'success' }}"]("like added");
                    } else {
                        this.innerHTML = '<i class="fa fa-thumbs-o-down" aria-hidden="true"></i>';
                        this.setAttribute('data-liked', 'false');
                        this.setAttribute('title', 'Click to like.');
                        toastr["{{ message.tags|default:'error' }}"]("like removed");
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    }



    function attachInterestIconHandlers() {
        const interestIcons = document.querySelectorAll('.interest-icon');
        interestIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const biodataId = this.getAttribute('data-biodata-id');
                const isLiked = this.getAttribute('data-liked') === 'true';

                fetch(`/post/${biodataId}/interest/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',  // Django's CSRF protection
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    toastr.options = {
                                "closeButton": true,           // Close button on the toast
                                "debug": false,
                                "newestOnTop": true,           // Display the newest toast on top
                                "progressBar": true,           // Show progress bar
                                "positionClass": "toast-top-right", // Position of the toast (you can change to other positions)
                                "preventDuplicates": false,    // Allow duplicate toasts
                                "onclick": null,
                                "showDuration": "300",         // How long it takes to show (in milliseconds)
                                "hideDuration": "1000",        // How long it takes to hide (in milliseconds)
                                "timeOut": "1000",             // Display duration of the toast (5000ms = 5 seconds)
                                "extendedTimeOut": "2000",     // Extra time when hovering over the toast (in milliseconds)
                                "showEasing": "swing",         // Animation easing when showing the toast
                                "hideEasing": "linear",        // Animation easing when hiding the toast
                                "showMethod": "fadeIn",        // Show method
                                "hideMethod": "fadeOut"        // Hide method
                              };
                    if (data.interested) {
                        this.innerHTML = 'interested'; // Liked state
                        this.setAttribute('data-liked', 'true');
                        this.setAttribute('class', 'text-white bg-success');
                        this.setAttribute('title', 'Click to remove like.');
                        toastr["{{ message.tags|default:'success' }}"]("interest sent succesfully");

                    } else {
                        this.innerHTML = 'send interest'; // Not liked state
                        this.setAttribute('data-liked', 'false');
                        this.setAttribute('class', 'text-dark bg-white');
                        this.setAttribute('title', 'Click to like.');
                        toastr["{{ message.tags|default:'error' }}"]("interest revoked");
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    }


    document.addEventListener('DOMContentLoaded', attachLikeIconHandlers);
    document.addEventListener('DOMContentLoaded', attachInterestIconHandlers);
</script>
